<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hitler Казино — Сделано Nicevy</title>
<style>
  :root{
    --bg:#0b0607;
    --card:#130607;
    --muted:#c7a8a8;
    --accent:#ff3b30;   /* основная красная */
    --accent-2:#ff6b6b; /* второй красный */
    --glass: rgba(255,255,255,0.02);
    --success:#39d353;
    --danger:#ff4d4f;
    --gold:#ffb74d;
  }
  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:
    radial-gradient(1000px 500px at 10% 10%, rgba(255,59,48,0.06), transparent),
    radial-gradient(900px 400px at 90% 90%, rgba(255,102,102,0.03), transparent),
    var(--bg); color:#ffecec; -webkit-font-smoothing:antialiased;}
  .app{
    max-width:1200px;margin:32px auto;padding:20px;border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); box-shadow: 0 8px 40px rgba(0,0,0,0.8); display:grid; grid-template-columns: 1fr 320px; gap:18px;
  }

  header{grid-column:1/-1; display:flex; align-items:center; justify-content:space-between;margin-bottom:8px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{
    width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#fff; box-shadow:0 8px 28px rgba(255,59,48,0.14); transform:rotate(-6deg);
  }
  h1{font-size:20px;margin:0}
  .desc{font-size:12px;color:var(--muted); margin-top:4px}

  .balance{
    background:var(--glass); padding:10px 14px;border-radius:12px;display:flex;align-items:center;gap:10px;min-width:200px;justify-content:space-between;
    border: 1px solid rgba(255,255,255,0.03);
  }
  .balance .amount{font-weight:800;font-size:18px}
  .balance small{color:var(--muted);font-size:12px}

  main{display:flex;gap:18px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border-radius:12px; padding:18px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.01);}

  .left{flex:1; min-height:520px}
  .right{width:320px}

  .controls{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .bet{display:flex;gap:8px;align-items:center}
  input[type=number]{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:inherit;width:120px}
  button.btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(255,59,48,0.12);transition:transform .12s}
  button.btn:active{transform:translateY(2px)}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}

  .game-area{height:420px;border-radius:10px;padding:16px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03)); display:flex;flex-direction:column; gap:12px; justify-content:flex-start}
  .game-header{display:flex;align-items:center;justify-content:space-between}
  .game-title{font-size:18px;font-weight:800;color:var(--accent)}
  .game-sub{font-size:12px;color:var(--muted)}

  /* Roulette wheel */
  .wheel-wrap{display:flex;gap:18px;align-items:center;justify-content:center;flex:1}
  .wheel{
    width:260px;height:260px;border-radius:50%;position:relative;overflow:hidden;border:8px solid rgba(255,255,255,0.03);box-shadow:0 12px 50px rgba(0,0,0,0.7);
    display:flex;align-items:center;justify-content:center;transform:rotate(0deg);
    transition: transform 4s cubic-bezier(.2,.9,.2,1);
    background: conic-gradient(#ff6b6b 0deg, rgba(255,255,255,0.02) 0deg);
  }
  .wheel .center{width:86px;height:86px;border-radius:999px;background:linear-gradient(180deg,#120406, #220409); display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--gold);box-shadow:0 6px 20px rgba(255,59,48,0.06)}
  .pointer{position:absolute; top:8px; left:50%; transform:translateX(-50%); width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid var(--gold); filter:drop-shadow(0 6px 12px rgba(0,0,0,0.6)); z-index:6}
  /* Arrow that will rotate to point to the landed segment */
  .wheel-arrow{
    position:absolute; left:50%; top:50%; width:8px; height:120px; transform-origin:50% 80%; pointer-events:none; z-index:7;
    transform:translate(-50%,-50%) rotate(-90deg);
  }
  .wheel-arrow .shaft{width:100%;height:100%; background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border-radius:6px; box-shadow:0 8px 18px rgba(0,0,0,0.6)}
  .wheel-arrow .tip{position:absolute; right:-10px; top:8px; width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:14px solid var(--accent); transform:translateX(50%) rotate(90deg)}

  .wheel-legend{display:flex;flex-direction:column;gap:8px}
  .leg-item{display:flex;align-items:center;gap:10px}
  .leg-dot{width:20px;height:20px;border-radius:6px;display:inline-block}
  .dot-2{background:linear-gradient(90deg,#ff6b6b,#ff4d4f)}
  .dot-3{background:linear-gradient(90deg,#ff9a9a,#ff6b6b)}
  .dot-5{background:linear-gradient(90deg,#ffb74d,#ff8a00)}

  /* Crash */
  .crash-graph{height:220px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border-radius:10px;display:flex;align-items:flex-end;padding:10px;gap:10px;overflow:hidden}
  .crash-bar{width:12px;border-radius:4px;background:linear-gradient(180deg,var(--accent),var(--accent-2));opacity:0.85; transform-origin:bottom; transition:height .08s linear}
  .crash-controls{display:flex;gap:10px;align-items:center}

  /* Mines */
  .mine-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;background:transparent}
  .cell{width:36px;height:36px;border-radius:6px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,0.02); user-select:none}
  .cell.safe{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); color:var(--gold)}
  .cell.mine{background:linear-gradient(180deg,var(--danger),#9a2a2a); color:#fff}
  .cell.flag{background:linear-gradient(180deg,#ffd166,#ff9f1c); color:#081220}

  /* right column */
  .panel .menu{display:flex;flex-direction:column;gap:8px}
  .game-btn{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;cursor:pointer;border:1px solid rgba(255,255,255,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.005), rgba(0,0,0,0.02))}
  .active{box-shadow:0 8px 30px rgba(0,0,0,0.5);border:1px solid rgba(255,59,48,0.18);background:linear-gradient(180deg, rgba(255,59,48,0.03), rgba(0,0,0,0.03))}
  .small{font-size:12px;color:var(--muted)}
  footer{grid-column:1/-1;margin-top:8px;color:var(--muted);font-size:12px;text-align:center}

  /* Splash modal */
  #splash{position:fixed;inset:0;background:linear-gradient(0deg, rgba(2,6,23,0.85), rgba(2,6,23,0.95));display:flex;align-items:center;justify-content:center;z-index:9999}
  .splash-card{width:min(820px,95%);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));padding:28px;border-radius:16px;text-align:center;border:1px solid rgba(255,255,255,0.02)}
  .splash-logo{font-size:48px;font-weight:800; letter-spacing:2px; color:var(--accent)}
  .disclaimer{margin-top:16px;color:var(--muted); font-size:14px; line-height:1.4; text-align:left; background:rgba(255,255,255,0.01); padding:12px;border-radius:10px; border:1px dashed rgba(255,255,255,0.02)}
  .big{font-size:18px;font-weight:700;margin-top:12px}

  @media (max-width:980px){
    .app{grid-template-columns:1fr; padding:12px}
    .right{width:100%}
    .left{order:2}
  }
</style>
</head>
<body>

<div id="splash">
  <div class="splash-card">
    <div class="splash-logo">СДЕЛАНО Nicevy</div>
    <div class="big">Hitler Казино — Просто шутка, игра и мемный проект</div>
    <div class="disclaimer">
      <strong>Дисклеймер:</strong>
      <p>Мы не одобряем и не используем никакую экстремистскую символику или идеологии. Любые совпадения случайны. Этот проект — пародия/игра без реальных ставок. Всё сделано в шутку и в развлекательных целях.</p>
    </div>
    <div style="margin-top:18px;display:flex;gap:12px;justify-content:center">
      <button class="btn" id="enterBtn">ПРОДОЛЖИТЬ — ВПЕРЁД К ИГРАМ!</button>
      <button class="ghost" id="closeBtn">Закрыть (не заходить)</button>
    </div>
  </div>
</div>

<div class="app" role="application" aria-label="Hitler Казино">
  <header>
    <div class="brand">
      <div class="logo">HL</div>
      <div>
        <h1>Hitler Казино <span style="font-weight:400;color:var(--muted)">— заказали у меня рекламу (ура)</span></h1>
        <div class="desc">Красная тема • Локальные монеты • Рулетка • Краш • Сапёр</div>
      </div>
    </div>

    <div class="balance" title="Баланс HitlerCoin">
      <div>
        <div style="font-size:12px;color:var(--muted)">Баланс</div>
        <div class="amount" id="balance">0</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:12px;color:var(--muted)">Коин</div>
        <small>HitlerCoin</small>
      </div>
    </div>
  </header>

  <main>
    <section class="left panel">
      <div class="controls">
        <div class="bet">
          <label style="font-size:12px;color:var(--muted)">Ставка</label>
          <input type="number" id="betInput" value="1" min="1" step="1" />
          <button class="ghost" id="maxBtn">Max</button>
        </div>

        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <button class="ghost" id="resetCoins">Сбросить</button>
          <div class="small" id="resetTimerInfo" style="color:var(--muted)"></div>
        </div>
      </div>

      <div class="game-area" id="gameArea">
        <!-- dynamic content -->
      </div>
    </section>

    <aside class="right panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div>
          <div style="font-weight:800">Игры</div>
          <div class="small">Выбери режим</div>
        </div>
        <div class="small" id="stats">Ставка: —</div>
      </div>

      <div class="menu">
        <div class="game-btn active" data-game="roulette" id="btn-roulette">
          <div>
            <div style="font-weight:700">Рулетка</div>
            <div class="small">Выбери множитель и крути колесо</div>
          </div>
          <div class="small">x2 x3 x5</div>
        </div>
        <div class="game-btn" data-game="crash" id="btn-crash">
          <div>
            <div style="font-weight:700">Краш</div>
            <div class="small">Собери множитель до краша</div>
          </div>
          <div class="small">до 100x</div>
        </div>
        <div class="game-btn" data-game="mines" id="btn-mines">
          <div>
            <div style="font-weight:700">Сапёр</div>
            <div class="small">10x10, 5 мин</div>
          </div>
          <div class="small">Риск/нагруз</div>
        </div>
      </div>

      <div style="margin-top:16px;border-top:1px solid rgba(255,255,255,0.02);padding-top:12px">
        <div style="font-weight:700">Информация</div>
        <div class="small" style="margin-top:8px">
          Монеты сохраняются лишь локально в браузере. Это демо-игра. Победы и проигрыши — имитация.
        </div>
      </div>
    </aside>
  </main>

  <footer>
    <div>© Сделано Nicevy — это лишь игра. Мы не поддерживаем ничего экстремистского.</div>
  </footer>
</div>

<script>
/* ========== Utilities & State ========== */
const STORAGE_KEY = 'nice_casino_balance_v1';
const RESET_KEY = 'nice_casino_last_reset_v1';
let state = {
  balance: 0,
  currentGame: 'roulette', // roulette | crash | mines
  runningCrash: false,
  crashInterval: null,
  crashData: null, // {crashAt, currentMult, startedAt}
  minesField: null,
  minesOpened: 0,
  resetCooldownUntil: 0,
};

function saveBalance(){ localStorage.setItem(STORAGE_KEY, String(state.balance)); updateBalanceUI(); }
function loadBalance(){ const v = parseInt(localStorage.getItem(STORAGE_KEY)); if(isNaN(v)){ state.balance = 10 } else state.balance = v; updateBalanceUI(); }
function updateBalanceUI(){ document.getElementById('balance').innerText = state.balance.toString(); }

/* reset cooldown persistence */
function loadResetCooldown(){
  const last = parseInt(localStorage.getItem(RESET_KEY)) || 0;
  const until = last + 10000; // last reset time + 10s
  state.resetCooldownUntil = until;
  refreshResetUI();
}
function setResetNow(){
  const now = Date.now();
  localStorage.setItem(RESET_KEY, String(now));
  state.resetCooldownUntil = now + 10000;
  refreshResetUI();
}

function refreshResetUI(){
  const btn = document.getElementById('resetCoins');
  const info = document.getElementById('resetTimerInfo');
  if(!btn) return;
  const now = Date.now();
  const rem = Math.max(0, Math.ceil((state.resetCooldownUntil - now) / 1000));
  if(rem > 0){
    btn.disabled = true;
    btn.style.opacity = '0.6';
    info.innerText = `Можно сбросить через ${rem}s`;
    // ensure interval to update countdown
    if(!refreshResetUI._interval){
      refreshResetUI._interval = setInterval(()=> {
        const now2 = Date.now();
        const rem2 = Math.max(0, Math.ceil((state.resetCooldownUntil - now2) / 1000));
        if(rem2 <= 0){
          btn.disabled = false;
          btn.style.opacity = '1';
          info.innerText = '';
          clearInterval(refreshResetUI._interval);
          refreshResetUI._interval = null;
        } else {
          info.innerText = `Можно сбросить через ${rem2}s`;
        }
      }, 500);
    }
  } else {
    btn.disabled = false;
    btn.style.opacity = '1';
    info.innerText = '';
  }
}

/* Initialize */
document.addEventListener('DOMContentLoaded', () => {
  loadBalance();
  loadResetCooldown();
  initControls();
  renderGameArea('roulette');
  wireMenuButtons();
  document.getElementById('enterBtn').addEventListener('click', ()=> document.getElementById('splash').style.display='none');
  document.getElementById('closeBtn').addEventListener('click', ()=> { document.getElementById('splash').style.display='none'; });
});

/* Controls */
function initControls(){
  const betInput = document.getElementById('betInput');
  const maxBtn = document.getElementById('maxBtn');
  maxBtn.addEventListener('click', ()=>{
    betInput.value = Math.max(1, state.balance);
  });

  const resetBtn = document.getElementById('resetCoins');
  resetBtn.addEventListener('click', ()=>{
    const now = Date.now();
    if(now < state.resetCooldownUntil){
      const rem = Math.ceil((state.resetCooldownUntil - now)/1000);
      alert('Сброс можно делать только раз в 10 секунд. Подождите ' + rem + 's.');
      return;
    }
    if(confirm('Сбросить баланс до 10 NiceCoin? (Можно сбросить только раз в 10 секунд)')){
      state.balance = 10;
      saveBalance();
      setResetNow();
      alert('Баланс сброшен до 10 NiceCoin.');
    }
  });
}

/* Menu */
function wireMenuButtons(){
  document.querySelectorAll('.game-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.game-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const g = btn.dataset.game;
      state.currentGame = g;
      renderGameArea(g);
    });
  });
}

/* ========== RENDER GAME AREAS ========== */
function renderGameArea(game){
  const area = document.getElementById('gameArea');
  area.innerHTML = '';
  if(game === 'roulette') renderRoulette(area);
  if(game === 'crash') renderCrash(area);
  if(game === 'mines') renderMines(area);
}

/* ------- ROULETTE ------- */
function renderRoulette(area){
  area.innerHTML = `
    <div class="game-header">
      <div>
        <div class="game-title">Рулетка</div>
        <div class="game-sub">Выбери множитель и сделай ставку. x2 встречается чаще, x5 — реже.</div>
      </div>
      <div style="text-align:right">
        <div class="small">Последний результат</div>
        <div id="rouletteResult" style="font-weight:700">—</div>
      </div>
    </div>

    <div class="wheel-wrap" style="gap:16px">
      <div style="display:flex;flex-direction:column;align-items:center;position:relative">
        <div class="pointer"></div>
        <div id="wheel" class="wheel">
          <div class="center">Крутить</div>
          <div id="wheelArrow" class="wheel-arrow" aria-hidden="true">
            <div class="shaft"></div>
            <div class="tip"></div>
          </div>
        </div>
      </div>
      <div class="wheel-legend">
        <div class="leg-item"><span class="leg-dot dot-2"></span> x2 — 5 долей</div>
        <div class="leg-item"><span class="leg-dot dot-3"></span> x3 — 3 доли</div>
        <div class="leg-item"><span class="leg-dot dot-5"></span> x5 — 1 доля</div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-top:8px">
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">Выбрать</label>
        <select id="roulettePick" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit">
          <option value="2">x2</option>
          <option value="3">x3</option>
          <option value="5">x5</option>
        </select>
      </div>
      <button class="btn" id="spinBtn">Крутить</button>
      <div id="spinInfo" class="small" style="min-width:240px;text-align:left"></div>
    </div>
  `;

  const wheel = document.getElementById('wheel');
  const arrow = document.getElementById('wheelArrow');

  // segments: x2 x5 times, x3 x3, x5 x1 => total 9
  const segs = [];
  for(let i=0;i<5;i++) segs.push({v:2, color:'#ff6b6b'});
  for(let i=0;i<3;i++) segs.push({v:3, color:'#ff9a9a'});
  segs.push({v:5, color:'#ffb74d'});

  shuffleArray(segs);
  const step = 360 / segs.length;
  let gradientParts = segs.map((s,i)=>{
    const start = i*step;
    const end = start + step;
    const color = s.v===2? '#ff6b6b' : s.v===3? '#ff9a9a' : '#ffb74d';
    return `${color} ${start}deg ${end}deg`;
  });
  wheel.style.background = `conic-gradient(${gradientParts.join(',')})`;
  wheel._segs = segs;

  document.getElementById('spinBtn').addEventListener('click', ()=>{
    const bet = parseInt(document.getElementById('betInput').value) || 0;
    if(!validateBet(bet)) return;
    spinRoulette(wheel, arrow, bet);
  });
}

function spinRoulette(wheel, arrow, bet){
  const pick = parseInt(document.getElementById('roulettePick').value,10);
  // consume bet
  state.balance -= bet;
  saveBalance();

  // pick random index from wheel._segs
  const idx = Math.floor(Math.random()*wheel._segs.length);
  const landed = wheel._segs[idx].v;

  // compute angles
  const step = 360 / wheel._segs.length;
  // targetAngle such that chosen segment center ends at top (pointer)
  const targetAngle = 360 - (idx * step + step/2);
  const spins = 5; // full spins
  const jitter = (Math.random()*step - step/2);
  const final = 360*spins + targetAngle + jitter;

  // animate both wheel and arrow:
  // wheel rotates (visual spin), arrow will rotate smoothly to point to the landed segment center angle
  // compute arrow final rotation (in degrees) so arrow points at the segment center in page coords:
  // segment center angle measured clockwise from right (0deg) is (idx*step + step/2).
  // we adjust so that 0deg => pointing right, subtract 90 to make it point up baseline.
  let segCenter = idx * step + step/2;
  const arrowAngle = segCenter - 90; // orient arrow so that 0->up

  // animate wheel
  wheel.style.transition = 'transform 3s cubic-bezier(.14,.94,.35,1)';
  wheel.style.transform = `rotate(${final}deg)`;

  // animate arrow rotation to arrowAngle (shorter rotation)
  // ensure smooth rotation by computing minimal rotation delta
  const curr = getRotationDegrees(arrow);
  // normalize
  const desired = arrowAngle;
  // choose target rotation that results in minimal movement visually
  let delta = ((desired - curr + 540) % 360) - 180; // -180..180
  let arrowFinal = curr + delta;

  arrow.style.transition = 'transform 3s cubic-bezier(.14,.94,.35,1)';
  arrow.style.transform = `translate(-50%,-50%) rotate(${arrowFinal}deg)`;

  document.getElementById('spinInfo').innerText = 'Крутим...';
  document.getElementById('spinBtn').disabled = true;

  setTimeout(()=>{
    // resolve
    document.getElementById('spinBtn').disabled = false;
    document.getElementById('spinInfo').innerText = '';
    document.getElementById('rouletteResult').innerText = 'x' + landed;
    if(landed === pick){
      const win = bet * landed;
      state.balance += win;
      saveBalance();
      document.getElementById('spinInfo').innerHTML = `<span style="color:var(--success)">Вы выиграли ${win} NiceCoin (x${landed})</span>`;
    } else {
      document.getElementById('spinInfo').innerHTML = `<span style="color:var(--danger)">Проигрыш — выпадало x${landed}</span>`;
    }
    // gently reset wheel and keep arrow pointing at the landed segment visually (no sudden flick)
    setTimeout(()=>{ wheel.style.transition='transform 0.6s ease'; wheel.style.transform='rotate(0deg)'; }, 300);
    // keep arrow rotated to indicate where it landed (no reset)
  }, 3000);
}

/* read current rotation in degrees of element's transform */
function getRotationDegrees(el){
  const st = window.getComputedStyle(el, null);
  const tr = st.getPropertyValue("transform");
  if(!tr || tr === 'none') return -90; // initial is -90 in CSS
  // matrix(a, b, c, d, e, f)
  const values = tr.split('(')[1].split(')')[0].split(',');
  if(values.length >= 6){
    const a = parseFloat(values[0]);
    const b = parseFloat(values[1]);
    const angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
    return angle;
  }
  return -90;
}

/* ------- CRASH ------- */
function renderCrash(area){
  state.runningCrash = false;
  area.innerHTML = `
    <div class="game-header">
      <div>
        <div class="game-title">Краш</div>
        <div class="game-sub">Ставь, наблюдай как растёт множитель и забирай — до краша.</div>
      </div>
      <div style="text-align:right">
        <div class="small">Текущий множитель</div>
        <div id="crashCurrent" style="font-weight:700">1.00x</div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <div class="crash-graph" id="crashGraph"></div>
        <div class="crash-controls" style="margin-top:8px">
          <button class="btn" id="startCrash">Начать раунд</button>
          <button class="ghost" id="cashoutBtn" disabled>Забрать</button>
          <div id="crashInfo" class="small" style="margin-left:auto"></div>
        </div>
      </div>
      <div style="width:200px;display:flex;flex-direction:column;gap:8px">
        <div class="small">Текущая ставка</div>
        <div style="font-weight:700;font-size:18px" id="crashBetLabel">—</div>
        <div class="small">Примерный риск: 50% краш ниже 1.5x</div>
      </div>
    </div>
  `;

  // prepare graph bars
  const graph = document.getElementById('crashGraph');
  graph.innerHTML = '';
  for(let i=0;i<40;i++){
    const b = document.createElement('div'); b.className='crash-bar'; b.style.height='4px'; graph.appendChild(b);
  }

  document.getElementById('startCrash').addEventListener('click', ()=> {
    const bet = parseInt(document.getElementById('betInput').value) || 0;
    if(!validateBet(bet)) return;
    startCrashRound(bet);
  });

  document.getElementById('cashoutBtn').addEventListener('click', ()=> {
    cashoutCrash();
  });
}

function startCrashRound(bet){
  // consume bet
  state.balance -= bet;
  saveBalance();

  // determine crash point
  if(Math.random() < 0.5){
    var crashAt = 1 + Math.random() * 0.5; // 1.00 - 1.50 common
  } else {
    var crashAt = 1.5 + Math.pow(Math.random(), 3) * (100 - 1.5);
  }
  crashAt = Math.max(1.01, +crashAt.toFixed(3));

  state.crashData = { crashAt, currentMult:1.00, startedAt:Date.now(), bet };
  state.runningCrash = true;

  document.getElementById('crashCurrent').innerText = '1.00x';
  document.getElementById('cashoutBtn').disabled = false;
  document.getElementById('startCrash').disabled = true;
  document.getElementById('crashInfo').innerText = 'Растёт...';

  const start = Date.now();
  const update = ()=>{
    if(!state.runningCrash) return;
    const t = (Date.now() - start) / 1000; // seconds
    const k = 0.6;
    let mult = Math.min(state.crashData.crashAt, 1.0 + Math.exp(k*t) - 1);
    if(mult < 1.0) mult = 1.0;
    state.crashData.currentMult = +mult.toFixed(3);
    document.getElementById('crashCurrent').innerText = state.crashData.currentMult.toFixed(2) + 'x';
    const bars = document.querySelectorAll('.crash-bar');
    for(let i=0;i<bars.length;i++){
      const h = Math.min(200, (Math.sin((t+i)/4 + i/10)*30 + state.crashData.currentMult*8 + (i*3)));
      bars[i].style.height = Math.max(6, Math.min(200, h)) + 'px';
    }
    if(state.crashData.currentMult >= state.crashData.crashAt - 0.0001){
      state.runningCrash = false;
      document.getElementById('crashInfo').innerHTML = `<span style="color:var(--danger)">Краш! x${state.crashData.crashAt.toFixed(2)}</span>`;
      document.getElementById('cashoutBtn').disabled = true;
      document.getElementById('startCrash').disabled = false;
      state.crashData = null;
      return;
    }
    state.crashInterval = requestAnimationFrame(update);
  };
  state.crashInterval = requestAnimationFrame(update);
}

function cashoutCrash(){
  if(!state.crashData) return;
  const mult = state.crashData.currentMult || 1;
  const win = Math.floor(state.crashData.bet * mult);
  state.balance += win;
  saveBalance();
  document.getElementById('crashInfo').innerHTML = `<span style="color:var(--success)">Вы забрали ${win} NiceCoin (x${mult.toFixed(2)})</span>`;
  state.runningCrash = false;
  cancelAnimationFrame(state.crashInterval);
  state.crashData = null;
  document.getElementById('cashoutBtn').disabled = true;
  document.getElementById('startCrash').disabled = false;
}

/* ------- MINES (Сапёр) ------- */
function renderMines(area){
  area.innerHTML = `
    <div class="game-header">
      <div>
        <div class="game-title">Сапёр (10×10)</div>
        <div class="game-sub">Выбирай клетки, избегай 5 бомб. Каждый безопасный выбор увеличивает множитель.</div>
      </div>
      <div style="text-align:right">
        <div class="small">Мин в поле</div>
        <div style="font-weight:700">5</div>
      </div>
    </div>

    <div style="display:flex;gap:14px">
      <div style="flex:1">
        <div class="mine-grid" id="mineGrid"></div>
      </div>
      <div style="width:220px;display:flex;flex-direction:column;gap:8px">
        <div><div class="small">Ставка</div><div id="mineBetLabel" style="font-weight:700">—</div></div>
        <div><div class="small">Открыто</div><div id="mineOpened" style="font-weight:700">0</div></div>
        <div><div class="small">Текущий множитель</div><div id="mineMult" style="font-weight:700">1.00x</div></div>
        <div style="margin-top:12px">
          <button class="btn" id="startMines">Новая раскладка & начать</button>
          <button class="ghost" id="collectMines" disabled style="margin-top:8px">Забрать</button>
        </div>
        <div class="small" style="margin-top:6px">Пассивная подсказка: вероятность пробить безопасные клетки падает с каждым открытием.</div>
      </div>
    </div>
  `;

  const grid = document.getElementById('mineGrid');
  grid.innerHTML = '';
  for(let i=0;i<100;i++){
    const c = document.createElement('div');
    c.className='cell';
    c.dataset.index = i;
    c.addEventListener('click', onMineClick);
    grid.appendChild(c);
  }

  document.getElementById('startMines').addEventListener('click', ()=> {
    const bet = parseInt(document.getElementById('betInput').value) || 0;
    if(!validateBet(bet)) return;
    initMinesRound(bet);
  });

  document.getElementById('collectMines').addEventListener('click', ()=> {
    collectMines();
  });
}

function initMinesRound(bet){
  state.balance -= bet;
  saveBalance();

  const bombs = new Set();
  while(bombs.size < 5){
    bombs.add(Math.floor(Math.random()*100));
  }
  state.minesField = { bombs: bombs, bet, opened: new Set(), alive: true };
  state.minesOpened = 0;
  updateMinesUI();
}

function onMineClick(e){
  if(!state.minesField || !state.minesField.alive) return;
  const idx = parseInt(e.currentTarget.dataset.index,10);
  const cell = e.currentTarget;
  if(state.minesField.opened.has(idx)) return;
  if(state.minesField.bombs.has(idx)){
    cell.classList.add('mine');
    cell.innerText = '💥';
    state.minesField.alive = false;
    document.querySelectorAll('.cell').forEach((c, i)=> {
      if(state.minesField.bombs.has(i)) { c.classList.add('mine'); c.innerText='💣'; }
      c.removeEventListener('click', onMineClick);
    });
    document.getElementById('collectMines').disabled = true;
    document.getElementById('mineMult').innerHTML = `<span style="color:var(--danger)">Сгорел! Вы потеряли ставку</span>`;
    return;
  } else {
    state.minesField.opened.add(idx);
    state.minesOpened++;
    cell.classList.add('safe');
    cell.innerText = getCellTextByAdj(idx, state.minesField.bombs);
    document.getElementById('collectMines').disabled = false;
    updateMinesUI();
  }
}

function getCellTextByAdj(idx, bombs){
  const r = Math.floor(idx/10), c = idx%10;
  let cnt = 0;
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    if(dr===0 && dc===0) continue;
    const nr=r+dr, nc=c+dc;
    if(nr<0||nr>9||nc<0||nc>9) continue;
    const ni = nr*10+nc;
    if(bombs.has(ni)) cnt++;
  }
  return cnt?String(cnt):'';
}

function updateMinesUI(){
  document.getElementById('mineOpened').innerText = state.minesOpened.toString();
  document.getElementById('mineBetLabel').innerText = state.minesField? String(state.minesField.bet) : '—';
  const mult = calcMinesMult(state.minesOpened);
  document.getElementById('mineMult').innerText = mult.toFixed(2) + 'x';
}

function calcMinesMult(opened){
  const table = [1.00, 1.10, 1.20, 1.40, 1.60, 1.90, 2.30, 2.90, 3.80, 5.00, 7.00];
  return table[Math.min(table.length-1, opened)];
}

function collectMines(){
  if(!state.minesField || !state.minesField.alive) return;
  const mult = calcMinesMult(state.minesOpened);
  const win = Math.floor(state.minesField.bet * mult);
  state.balance += win;
  saveBalance();
  document.querySelectorAll('.cell').forEach((c, i)=>{
    c.removeEventListener('click', onMineClick);
  });
  state.minesField.alive = false;
  document.getElementById('collectMines').disabled = true;
  document.getElementById('mineMult').innerHTML = `<span style="color:var(--success)">Вы забрали ${win} NiceCoin</span>`;
}

/* ====== General helpers ====== */
function validateBet(bet){
  if(!Number.isFinite(bet) || bet<=0){ alert('Ставка должна быть числом > 0'); return false; }
  if(bet > state.balance){ alert('Недостаточно NiceCoin. Уменьшите ставку.'); return false; }
  return true;
}
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* Reset cooldown load on script load */
(function(){
  // initialize stored reset time properly on page load
  const last = parseInt(localStorage.getItem(RESET_KEY)) || 0;
  state.resetCooldownUntil = last + 10000;
})();

/* ensure reset UI updates */
setTimeout(()=>{ loadResetCooldown(); }, 200);

/* End of script */
</script>

</body>
</html>
